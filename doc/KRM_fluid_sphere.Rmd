---
title: "KRM - Benchmark"
author: "Sven Gastauer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{KRM Benchmark}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(ggplot2)
```

Testing the rKRM implementation of the KRM - Kirchhoff Ray Mode - model, based on equations described in detail in 'Acoustic models of fish: The Atlantic cod (Gadus morhua)' by Clay and Horne, 1994.  

The KRM and the underlying scattering theory holds validity for high frequencies (>>> resonance freqeuncy) and for incident angles between 65 and 115 degrees.  

Shapes are approximated shapes through a series of cylinders. x coordinates are the along body coordinates (major axis of an ellipsoid) z coordinates are the upper and lower coordinates at position x (the upper and lower values of the minor axis). w defines the width frpm a top view along the body axis.  

The model is split in two parts:  
1) The Swimbladder (or gas bubble) part  
2) The Fish body (or fluid like) part

## Weakly scattering fluid Sphere
To approximate scattering by a fluid sphere through the KRM mo9del, we set the swimbladder part to 0 and only consider the Fish body part.  
We first define the sphere parameters:  

```{r wfs_parameters}
library(KRMr)
#Define the the sphere parameters
freqs = 10:400 * 1000 #Hz frequencies to be considered in Hz
a = 0.01 #m radius of the sphere
cw = 1477.4 #m/s sound speed surrounding water
cfb =  1480.3 #m/s soundspeed inside the sphere
rhow = 1026.8 #kg/m3 density surrounding water
rhofb = 1028.9 #kg/m3 density fluid inside sphere

```

Now we can construct shape information that is understoof by the KRM model:  

```{r Generate_Sphere_shape, fig.width=7,fig.height=6}
#generate sphere coordinates
ang = seq(-90,90,length.out=30) #angles to consider
xfb = sin(ang * pi / 180) #x coordinates of a sphere
wfb = (2*cos(ang * pi / 180)) #diameter of the sphere
zfbU = cos(ang * pi / 180) #upper z coordinates
zfbL = -cos(ang * pi / 180) #lower z coordiates

shplot(x_fb = xfb,w_fb = wfb,z_fbU = zfbU, z_fbL=zfbL)

```

Now we can run the KRM simulation:  

```{r KRM_simulation_wfs}
kfs = krm.sim(frequency =10:400 * 1000,
              c.w = cw,
              rho.w = rhow,
              theta=90,
              c.fb = cfb,
              rho.fb = rhofb,
              L=0.02,
              x_fb =xfb,
              x_sb = 0,
              w_fb = wfb,
              w_sb = 0,
              z_fbU = zfbU,
              z_fbL = zfbL,
              z_sbU = 0,
              z_sbL = 0)
```


We will use the analytical solution of the scattering by a fluid sphere as descirbed in Jech et al. 2015, modified from Anderson (1950).

*Jech, J. M., Horne, J. K., Chu, D., Demer, D. A., Francis, D. T., Gorska, N., ... & Reeder, D. B. (2015)."Comparisons among ten models of acoustic backscattering used in aquatic ecosystem research." The Journal of the Acoustical Society of America, 138(6), 3742-3764.  
Anderson, V. C. (1950). "Sound scattering from a fluid sphere." The Journal of the Acoustical Society of America, 22(4), 426-431.*

```{r Analytical_Sphere_wfs}
kfs$bench=sapply(freqs,
                 function(f){
                   fsphere(f,a,cw,cfb/cw,
                             rhofb/rhow)})
```


Plotting the results:  

```{r wfs_results, fig.width=7,fig.height=6}
colors <- c("Analytical" = "red", "KRM" = "blue")

ggplot2::ggplot()+
  ggplot2::geom_line(data=kfs, ggplot2::aes(x=frequency/1000,y=TS, group=L,col='KRM'),lwd=1)+
  ggplot2::geom_line(data=kfs, ggplot2::aes(x=frequency/1000, group=L, y=bench,col='Analytical'), lty=2,lwd=1)+
  ggplot2::scale_color_manual(values = colors, name='')+
  ggplot2::xlab('Frequency (kHz)')+
  ggplot2::ylab('Target Strength (dB re m-2)')+
  ggplot2::theme_classic()+
  ggplot2::theme(text=ggplot2::element_text(size=16),
        legend.position='top')

```

## Gas filled fluid sphere

```{r gfs_parameters}

#Define the the sphere parameters
freqs = seq(12,400,1) * 1000 #Hz frequencies to be considered in Hz
a = 0.01 #m radius of the sphere
cw = 1477.4 #m/s sound speed surrounding water
cfb =  345.0 #m/s soundspeed inside the sphere
rhow = 1026.8 #kg/m3 density surrounding water
rhofb = 1.24 #kg/m3 density fluid inside sphere

```


Now we can run the KRM simulation:  

```{r KRM_simulation_gfs}
kfs = krm.sim(frequency =freqs,
              c.w = cw,
              rho.w = rhow,
              theta=90,
              c.sb = cfb,
              rho.sb = rhofb,
              L=0.02,
              x_sb =xfb,
              w_sb = wfb,
              z_sbU = zfbU,
              z_sbL = zfbL)
```


We will use the analytical solution of the scattering by a fluid sphere as descirbed in Jech et al. 2015, modified from Anderson (1950).

*Jech, J. M., Horne, J. K., Chu, D., Demer, D. A., Francis, D. T., Gorska, N., ... & Reeder, D. B. (2015)."Comparisons among ten models of acoustic backscattering used in aquatic ecosystem research." The Journal of the Acoustical Society of America, 138(6), 3742-3764.  
Anderson, V. C. (1950). "Sound scattering from a fluid sphere." The Journal of the Acoustical Society of America, 22(4), 426-431.*

```{r Analytical_Sphere_gfs}
kfs$bench=sapply(freqs,
                 function(f){
                   fsphere(f,a,cw,cfb/cw,
                             rhofb/rhow)})
```


Plotting the results:  

```{r gfs_results, fig.width=7,fig.height=6}
colors <- c("Analytical" = "red", "KRM" = "blue")

ggplot2::ggplot()+
  ggplot2::geom_line(data=kfs, ggplot2::aes(x=frequency/1000,y=TS, group=L,col='KRM'),lwd=1)+
  ggplot2::geom_line(data=kfs, ggplot2::aes(x=frequency/1000, group=L, y=bench,col='Analytical'), lty=2,lwd=1)+
  ggplot2::scale_color_manual(values = colors, name='')+
  scale_y_continuous(limits=c(-50,-40))+
  ggplot2::xlab('Frequency (kHz)')+
  ggplot2::ylab('Target Strength (dB re m-2)')+
  ggplot2::theme_classic()+
  ggplot2::theme(text=ggplot2::element_text(size=16),
        legend.position='top')

```

## Sardine (like)

First we define the shape of a sardine like fish. Here we take the sardine shape profile from the [NOAA SWFSC website](https://swfscdata.nmfs.noaa.gov/AST/KRM/krm.html).  

```{r}
#Sardine
fb = data.frame(
x_fb = c(0.000000, 0.000556, 0.001111, 0.001667, 0.002222, 0.002778, 0.003333, 0.003889, 0.004444, 0.005000, 0.005556, 0.006111, 0.006667, 0.007222, 0.007778, 0.008333, 0.008889, 0.009444, 0.010000, 0.010556, 0.011111, 0.011667, 0.012222, 0.012778, 0.013333, 0.013889, 0.014444, 0.015000, 0.015556, 0.016111, 0.016667, 0.017222, 0.017778, 0.018333, 0.018889, 0.019444, 0.020000, 0.020556, 0.021111, 0.021667, 0.022222, 0.022778, 0.023333, 0.023889, 0.024444, 0.025000, 0.025556, 0.026111, 0.026667, 0.027222, 0.027778, 0.028333, 0.028889, 0.029444, 0.030000, 0.030556, 0.031111, 0.031667, 0.032222, 0.032778, 0.033333, 0.033889, 0.034444, 0.035000, 0.035556, 0.036111, 0.036667, 0.037222, 0.037778, 0.038333, 0.038889, 0.039444, 0.040000, 0.040556, 0.041111, 0.041667, 0.042222, 0.042778, 0.043333, 0.043889, 0.044444, 0.045000, 0.045556, 0.046111, 0.046667, 0.047222, 0.047778, 0.048333, 0.048889, 0.049444, 0.050000, 0.050556, 0.051111, 0.051667, 0.052222, 0.052778, 0.053333, 0.053889, 0.054444, 0.055000, 0.055556, 0.056111, 0.056667, 0.057222, 0.057778, 0.058333, 0.058889, 0.059444, 0.060000, 0.060556, 0.061111, 0.061667, 0.062222, 0.062778, 0.063333, 0.063889, 0.064444, 0.065000, 0.065556, 0.066111, 0.066667, 0.067222, 0.067778, 0.068333, 0.068889, 0.069444, 0.070000, 0.070556, 0.071111, 0.071667, 0.072222, 0.072778, 0.073333, 0.073889, 0.074444, 0.075000, 0.075556, 0.076111, 0.076667, 0.077222, 0.077778, 0.078333, 0.078889, 0.079444, 0.080000, 0.080556, 0.081111, 0.081667, 0.082222, 0.082778, 0.083333, 0.083889, 0.084444, 0.085000, 0.085556, 0.086111, 0.086667, 0.087222, 0.087778, 0.088333, 0.088889, 0.089444, 0.090000, 0.090556, 0.091111, 0.091667, 0.092222, 0.092778, 0.093333, 0.093889, 0.094444, 0.095000, 0.095556, 0.096111, 0.096667, 0.097222, 0.097778, 0.098333, 0.098889, 0.099444, 0.100000, 0.100556, 0.101111, 0.101667, 0.102222, 0.102778, 0.103333, 0.103889, 0.104444, 0.105000, 0.105556, 0.106111, 0.106667, 0.107222, 0.107778, 0.108333, 0.108889, 0.109444, 0.110000, 0.110556, 0.111111, 0.111667, 0.112222, 0.112778, 0.113333, 0.113889, 0.114444, 0.115000, 0.115556, 0.116111, 0.116667, 0.117222, 0.117778, 0.118333, 0.118889, 0.119444, 0.120000, 0.120556, 0.121111, 0.121667, 0.122222, 0.122778, 0.123333, 0.123889, 0.124444, 0.125000, 0.125556, 0.126111, 0.126667, 0.127222, 0.127778, 0.128333, 0.128889, 0.129444, 0.130000, 0.130556, 0.131111, 0.131667, 0.132222, 0.132778, 0.133333, 0.133889, 0.134444, 0.135000, 0.135556, 0.136111, 0.136667, 0.137222, 0.137778, 0.138333, 0.138889, 0.139444, 0.140000, 0.140556, 0.141111, 0.141667, 0.142222, 0.142778, 0.143333, 0.143889, 0.144444, 0.145000, 0.145556, 0.146111, 0.146667, 0.147222, 0.147778, 0.148333, 0.148889, 0.149444, 0.150000, 0.150556, 0.151111, 0.151667, 0.152222, 0.152778, 0.153333, 0.153889, 0.154444, 0.155000, 0.155556, 0.156111, 0.156667, 0.157222, 0.157778, 0.158333, 0.158889, 0.159444, 0.160000, 0.160556, 0.161111, 0.161667, 0.162222, 0.162778, 0.163333, 0.163889, 0.164444, 0.165000, 0.165556, 0.166111, 0.166667, 0.167222, 0.167778, 0.168333, 0.168889, 0.169444, 0.170000, 0.170556, 0.171111, 0.171667, 0.172222, 0.172778, 0.173333, 0.173889, 0.174444, 0.175000, 0.175556, 0.176111, 0.176667, 0.177222, 0.177778, 0.178333, 0.178889, 0.179444, 0.180000, 0.180556, 0.181111, 0.181667, 0.182222, 0.182778, 0.183333, 0.183889, 0.184444, 0.185000, 0.185556, 0.186111, 0.186667, 0.187222, 0.187778, 0.188333, 0.188889, 0.189444, 0.190000, 0.190556, 0.191111, 0.191667, 0.192222, 0.192778, 0.193333, 0.193889, 0.194444, 0.195000, 0.195556, 0.196111, 0.196667, 0.197222, 0.197778, 0.198333, 0.198889, 0.199444, 0.200000, 0.200556, 0.201111, 0.201667, 0.202222, 0.202778, 0.203333, 0.203889, 0.204444, 0.205000, 0.205556, 0.206111, 0.206667, 0.207222, 0.207778, 0.208333, 0.208889, 0.209444, 0.210000),
w_fb = c(0.004444, 0.004444, 0.005556, 0.005556, 0.006111, 0.006667, 0.007222, 0.007222, 0.008333, 0.008333, 0.008333, 0.009444, 0.009444, 0.009444, 0.010556, 0.010556, 0.010556, 0.011667, 0.011667, 0.011667, 0.011667, 0.012778, 0.012778, 0.012778, 0.012778, 0.013889, 0.013889, 0.013889, 0.013889, 0.014444, 0.015000, 0.015000, 0.015556, 0.015556, 0.016111, 0.016667, 0.016667, 0.016667, 0.016667, 0.017222, 0.017222, 0.017778, 0.017778, 0.018333, 0.018333, 0.018333, 0.018333, 0.018333, 0.019444, 0.019444, 0.019444, 0.019444, 0.020556, 0.020556, 0.020556, 0.020556, 0.020556, 0.020556, 0.020556, 0.021667, 0.021667, 0.021667, 0.021667, 0.021667, 0.021667, 0.021667, 0.022222, 0.022222, 0.022778, 0.022778, 0.023333, 0.023333, 0.023333, 0.023333, 0.023333, 0.023333, 0.023333, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026667, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.026111, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025556, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.025000, 0.024444, 0.024444, 0.024444, 0.024444, 0.024444, 0.024444, 0.024444, 0.024444, 0.024444, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.023889, 0.023333, 0.023333, 0.023333, 0.023333, 0.023333, 0.023333, 0.023333, 0.023333, 0.023333, 0.022222, 0.022222, 0.022222, 0.022222, 0.022222, 0.022222, 0.022222, 0.022222, 0.022222, 0.021667, 0.021667, 0.021667, 0.021667, 0.021667, 0.021667, 0.021667, 0.021667, 0.021667, 0.020556, 0.020556, 0.020556, 0.020556, 0.020556, 0.020556, 0.020556, 0.020556, 0.020556, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.019444, 0.019444, 0.019444, 0.019444, 0.019444, 0.019444, 0.019444, 0.018889, 0.018889, 0.018333, 0.018333, 0.017778, 0.017778, 0.017778, 0.017778, 0.017778, 0.017778, 0.017778, 0.016667, 0.016667, 0.016667, 0.016667, 0.016667, 0.016667, 0.016667, 0.016667, 0.016667, 0.016111, 0.016111, 0.016111, 0.016111, 0.016111, 0.016111, 0.016111, 0.016111, 0.016111, 0.015000, 0.015000, 0.015000, 0.015000, 0.015000, 0.015000, 0.015000, 0.014444, 0.014444, 0.013889, 0.013889, 0.013333, 0.013333, 0.013333, 0.013333, 0.013333, 0.013333, 0.013333, 0.012222, 0.012222, 0.012222, 0.012222, 0.012222, 0.012222, 0.012222, 0.012222, 0.012222, 0.011111, 0.011111, 0.011111, 0.011111, 0.011111, 0.011111, 0.011111, 0.011111, 0.011111, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.009444, 0.009444, 0.008889, 0.008889, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333) ,
z_fbU = c(0.003611, 0.003611, 0.004167, 0.004167, 0.004722, 0.004722, 0.005278, 0.005278, 0.005833, 0.005833, 0.005833, 0.006389, 0.006389, 0.006944, 0.006944, 0.007500, 0.007500, 0.008056, 0.008056, 0.008056, 0.008056, 0.008611, 0.008611, 0.008611, 0.008611, 0.009167, 0.009167, 0.009167, 0.009167, 0.009722, 0.009722, 0.009722, 0.010278, 0.010278, 0.010278, 0.010833, 0.010833, 0.010833, 0.011389, 0.011389, 0.011389, 0.011944, 0.011944, 0.011944, 0.012500, 0.012500, 0.012500, 0.013056, 0.013056, 0.013056, 0.013611, 0.013611, 0.013611, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.016389, 0.016389, 0.016389, 0.016389, 0.016389, 0.016389, 0.016389, 0.016389, 0.016389, 0.016944, 0.016944, 0.016944, 0.016944, 0.016944, 0.016944, 0.016944, 0.016944, 0.016944, 0.017500, 0.017500, 0.017500, 0.017500, 0.017500, 0.017500, 0.017500, 0.017500, 0.017500, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018611, 0.018611, 0.018611, 0.018611, 0.018611, 0.018611, 0.018611, 0.018611, 0.018611, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.018056, 0.017500, 0.017500, 0.017500, 0.017500, 0.017500, 0.017500, 0.017500, 0.016944, 0.016944, 0.016944, 0.016944, 0.016389, 0.016389, 0.016389, 0.016389, 0.016389, 0.016389, 0.016389, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015833, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.015278, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.014722, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.014167, 0.013611, 0.013611, 0.013611, 0.013611, 0.013056, 0.013056, 0.013056, 0.013056, 0.013056, 0.013056, 0.013056, 0.012500, 0.012500, 0.012500, 0.012500, 0.012500, 0.012500, 0.012500, 0.012500, 0.012500, 0.011944, 0.011944, 0.011944, 0.011944, 0.011944, 0.011944, 0.011944, 0.011389, 0.011389, 0.011389, 0.011389, 0.010833, 0.010833, 0.010833, 0.010833, 0.010833, 0.010833, 0.010833, 0.010278, 0.010278, 0.010278, 0.010278, 0.010278, 0.010278, 0.010278, 0.010278, 0.010278, 0.009722, 0.009722, 0.009722, 0.009722, 0.009722, 0.009722, 0.009722, 0.009722, 0.009722, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.009167, 0.008611, 0.008611, 0.008611, 0.008611, 0.008611, 0.008611, 0.008611, 0.008611, 0.008611, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.008056, 0.007500, 0.007500, 0.007500, 0.007500, 0.006944, 0.006944, 0.006944, 0.006944, 0.006944, 0.006944, 0.006944, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.006389, 0.005833) ,
z_fbL = c(-0.003611,-0.004167,-0.004167,-0.004722,-0.005278,-0.005278,-0.005833,-0.006389,-0.006389,-0.006944,-0.007500,-0.008056
,-0.008056,-0.008611,-0.009167,-0.009722,-0.009722,-0.010278,-0.010833,-0.010833,-0.011389,-0.011389,-0.011389,-0.011944
,-0.011944,-0.011944,-0.012500,-0.012500,-0.013056,-0.013056,-0.013611,-0.014167,-0.014167,-0.014722,-0.015278,-0.015278
,-0.015833,-0.015833,-0.015833,-0.016389,-0.016389,-0.016389,-0.016389,-0.016944,-0.016944,-0.016944,-0.016944,-0.017500
,-0.017500,-0.017500,-0.018056,-0.018056,-0.018056,-0.018611,-0.018611,-0.018611,-0.019167,-0.019167,-0.019167,-0.019722
,-0.019722,-0.019722,-0.020278,-0.020278,-0.020278,-0.020278,-0.020833,-0.020833,-0.020833,-0.020833,-0.021389,-0.021389
,-0.021389,-0.021389,-0.021389,-0.021944,-0.021944,-0.021944,-0.021944,-0.022500,-0.022500,-0.022500,-0.022500,-0.022500
,-0.023056,-0.023056,-0.023056,-0.023056,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.024167,-0.024167,-0.024167
,-0.024167,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024167,-0.024167,-0.024167,-0.024167
,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722
,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722
,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722
,-0.024722,-0.024722,-0.024722,-0.024722,-0.024722,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167
,-0.024167,-0.024167,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.024167
,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167
,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167
,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.024167,-0.023611
,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.023611,-0.023056,-0.023056,-0.023056,-0.023056
,-0.023056,-0.023056,-0.023056,-0.023056,-0.023056,-0.022500,-0.022500,-0.022500,-0.022500,-0.022500,-0.022500,-0.022500
,-0.021944,-0.021944,-0.021944,-0.021944,-0.021389,-0.021389,-0.021389,-0.021389,-0.021389,-0.021389,-0.021389,-0.021944
,-0.021944,-0.021944,-0.021944,-0.021944,-0.021944,-0.021944,-0.021389,-0.021389,-0.021389,-0.021389,-0.020833,-0.020833
,-0.020833,-0.020833,-0.020833,-0.020833,-0.020833,-0.020278,-0.020278,-0.020278,-0.020278,-0.020278,-0.020278,-0.020278
,-0.020278,-0.020278,-0.019722,-0.019722,-0.019722,-0.019722,-0.019722,-0.019722,-0.019167,-0.019167,-0.019167,-0.018611
,-0.018611,-0.018611,-0.018056,-0.018056,-0.018056,-0.017500,-0.017500,-0.017500,-0.016944,-0.016944,-0.016944,-0.016389
,-0.016389,-0.016389,-0.016389,-0.016389,-0.016389,-0.016389,-0.016389,-0.016389,-0.016389,-0.016389,-0.016389,-0.015833
,-0.015833,-0.015833,-0.015278,-0.015278,-0.015278,-0.014722,-0.014722,-0.014722,-0.014167,-0.014167,-0.014167,-0.013611
,-0.013611,-0.013611,-0.013056,-0.013056,-0.013056,-0.012500,-0.012500,-0.012500,-0.011944,-0.011944,-0.011944,-0.011389
,-0.011389,-0.011389,-0.011389,-0.010833,-0.010833,-0.010833,-0.010833,-0.010278,-0.010278,-0.010278,-0.010278,-0.010278
,-0.009722,-0.009722,-0.009722,-0.009722,-0.009167,-0.009167,-0.009167,-0.009167,-0.008611,-0.008611,-0.008056,-0.008056
,-0.007500,-0.007500,-0.006944,-0.006944,-0.006944,-0.006944,-0.006944,-0.006944,-0.006389,-0.006389,-0.006389,-0.006389
,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389
,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389,-0.006389)
)
sb = data.frame(
  x_sb = c(0.065000, 0.065556, 0.066111, 0.066667, 0.067222, 0.067778, 0.068333, 0.068889, 0.069444, 0.070000, 0.070556, 0.071111, 0.071667, 0.072222, 0.072778, 0.073333, 0.073889, 0.074444, 0.075000, 0.075556, 0.076111, 0.076667, 0.077222, 0.077778, 0.078333, 0.078889, 0.079444, 0.080000, 0.080556, 0.081111, 0.081667, 0.082222, 0.082778, 0.083333, 0.083889, 0.084444, 0.085000, 0.085556, 0.086111, 0.086667, 0.087222, 0.087778, 0.088333, 0.088889, 0.089444, 0.090000, 0.090556, 0.091111, 0.091667, 0.092222, 0.092778, 0.093333, 0.093889, 0.094444, 0.095000, 0.095556, 0.096111, 0.096667, 0.097222, 0.097778, 0.098333, 0.098889, 0.099444, 0.100000, 0.100556, 0.101111, 0.101667, 0.102222, 0.102778, 0.103333, 0.103889, 0.104444, 0.105000, 0.105556, 0.106111, 0.106667, 0.107222, 0.107778, 0.108333, 0.108889, 0.109444, 0.110000, 0.110556, 0.111111, 0.111667, 0.112222, 0.112778, 0.113333, 0.113889, 0.114444, 0.115000, 0.115556, 0.116111, 0.116667, 0.117222, 0.117778, 0.118333, 0.118889, 0.119444, 0.120000, 0.120556, 0.121111, 0.121667, 0.122222, 0.122778, 0.123333, 0.123889, 0.124444, 0.125000, 0.125556, 0.126111, 0.126667, 0.127222, 0.127778, 0.128333, 0.128889, 0.129444, 0.130000, 0.130556, 0.131111, 0.131667, 0.132222, 0.132778, 0.133333, 0.133889, 0.134444, 0.135000, 0.135556, 0.136111, 0.136667, 0.137222, 0.137778, 0.138333, 0.138889, 0.139444, 0.140000, 0.140556, 0.141111, 0.141667, 0.142222, 0.142778, 0.143333, 0.143889, 0.144444, 0.145000, 0.145556, 0.146111, 0.146667, 0.147222, 0.147778, 0.148333, 0.148889, 0.149444, 0.150000),
   w_sb = c(0.005000, 0.005000, 0.006111, 0.006111, 0.006667, 0.007222, 0.007778, 0.007778, 0.008889, 0.008889, 0.008889, 0.010000, 0.010000, 0.010556, 0.011111, 0.011667, 0.011667, 0.012778, 0.012778, 0.012778, 0.012778, 0.013889, 0.013889, 0.013889, 0.013889, 0.015000, 0.015000, 0.015000, 0.015000, 0.015000, 0.015000, 0.015000, 0.015556, 0.015556, 0.015556, 0.015556, 0.015556, 0.015556, 0.015556, 0.015556, 0.015556, 0.014444, 0.014444, 0.014444, 0.014444, 0.014444, 0.014444, 0.014444, 0.014444, 0.014444, 0.013889, 0.013889, 0.013889, 0.013889, 0.013889, 0.013889, 0.013889, 0.013889, 0.013889, 0.012778, 0.012778, 0.012778, 0.012778, 0.012778, 0.012778, 0.012778, 0.012778, 0.012778, 0.011667, 0.011667, 0.011667, 0.011667, 0.011667, 0.011667, 0.011667, 0.011667, 0.011667, 0.010556, 0.010556, 0.010556, 0.010556, 0.010556, 0.010556, 0.010556, 0.010556, 0.010556, 0.009444, 0.009444, 0.009444, 0.009444, 0.009444, 0.009444, 0.009444, 0.009444, 0.009444, 0.008889, 0.008889, 0.008889, 0.008889, 0.008889, 0.008889, 0.008889, 0.008889, 0.008889, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.008333, 0.007222, 0.007222, 0.007222, 0.007222, 0.007222, 0.007222, 0.007222, 0.007222, 0.007222, 0.006111, 0.006111, 0.006111, 0.006111, 0.006111, 0.006111, 0.006111, 0.005000, 0.005000, 0.005000, 0.005000, 0.003889, 0.003889, 0.003889, 0.003889, 0.003889, 0.002778, 0.002778, 0.002778, 0.002778, 0.001667, 0.001667, 0.001667, 0.001667, 0.001667, 0.001667, 0.001667, 0.001667, 0.001667, 0.001667, 0.001667, 0.001667),
   z_sbU = c(0.002500, 0.002500, 0.002500, 0.002500, 0.002500, 0.001944, 0.001944, 0.001944, 0.001944, 0.001944, 0.001944, 0.001944, 0.001389, 0.001389, 0.001389, 0.001389, 0.000833, 0.000833, 0.000833, 0.000833, 0.000833, 0.000278, 0.000278, 0.000278, 0.000278, -0.000278, -0.000278, -0.000278, -0.000278, -0.000278, -0.000278, -0.000278, -0.000833, -0.000833, -0.000833, -0.000833, -0.000833, -0.000833, -0.000833, -0.001389, -0.001389, -0.001389, -0.001389, -0.001944, -0.001944, -0.001944, -0.001944, -0.002500, -0.002500, -0.002500, -0.003056, -0.003056, -0.003056, -0.003611, -0.003611, -0.003611, -0.004167, -0.004167, -0.004167, -0.004722, -0.004722, -0.004722, -0.005278, -0.005278, -0.005278, -0.005278, -0.005833, -0.005833, -0.005833, -0.005833, -0.006389, -0.006389, -0.006389, -0.006389, -0.006944, -0.006944, -0.006944, -0.007500, -0.007500, -0.007500, -0.008056, -0.008056, -0.008056, -0.008056, -0.008056, -0.008056, -0.008611, -0.008611, -0.008611, -0.008611, -0.008611, -0.008611, -0.008611, -0.008611, -0.008611, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009167, -0.009722, -0.009722, -0.009722, -0.009722, -0.009722, -0.009722, -0.009722, -0.010278, -0.010278, -0.010278, -0.010278, -0.010833, -0.010833, -0.010833, -0.010833, -0.010833, -0.010833, -0.010833, -0.011389, -0.011389, -0.011389, -0.011389, -0.011389, -0.011389, -0.011944, -0.011944, -0.011944, -0.012500, -0.012500, -0.012500, -0.013056, -0.013056, -0.013056, -0.013056, -0.013056, -0.013056, -0.013056, -0.013056, -0.013056, -0.013056, -0.013611),
 z_sbL = c(-0.001944, -0.002500, -0.003056, -0.003611, -0.004167, -0.004722, -0.005278, -0.005833, -0.006389, -0.006944, -0.007500, -0.008056, -0.008611, -0.009167, -0.009722, -0.010278, -0.010833, -0.011389, -0.011944, -0.012500, -0.012500, -0.013056, -0.013611, -0.013611, -0.014167, -0.014722, -0.014722, -0.015278, -0.015278, -0.015278, -0.015833, -0.015833, -0.015833, -0.015833, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016944, -0.016944, -0.016944, -0.016944, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018611, -0.018611, -0.018611, -0.018611, -0.018611, -0.018611, -0.018611, -0.018611, -0.018611, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.018056, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.017500, -0.016944, -0.016944, -0.016944, -0.016944, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.016389, -0.015833, -0.015833, -0.015833, -0.015833, -0.015833, -0.015833, -0.015833, -0.015278, -0.015278, -0.015278, -0.015278, -0.014722, -0.014722, -0.014722, -0.014722, -0.014722, -0.014722, -0.014722, -0.014722, -0.014722, -0.014722, -0.014722, -0.014722))
```

Now we can have a look at the shape:  
```{r fig.width=7,fig.height=3}
shplot(x_fb = fb$x_fb, w_fb = fb$w_fb, x_sb = sb$x_sb, w_sb = sb$w_sb,z_fbU = fb$z_fbU,z_fbL = fb$z_fbL,z_sbU = sb$z_sbU,z_sbL = sb$z_sbL)
```

Because we have defined the fishbody coordinates and the swimbladder coordinates in a dataframe, the most simple way to run one KRM simulation in KRMr is:

```{r}
krm(fbshape = fb, sbshape = sb)
```


Now we are ready to run a KRM simulation. Let's have a look at the TS for a 21 cm sardine from 120 to 200 kHz. Here we will define the different coordinates separately and add the parameters we want to simulate:  

```{r}
TS = krm.sim(frequency =seq(20,200.1) * 1000,
         c.w = 1490,
         rho.w = 1030,
         theta=90,
         c.fb = 1570,
         c.sb = 345,
         rho.sb = 1.24,
         rho.fb = 1070,
         L=0.21,
         x_fb = fb$x_fb,
         x_sb = sb$x_sb,
         w_fb = fb$w_fb,
         w_sb = sb$w_sb,
         z_fbU = fb$z_fbU,
         z_fbL = fb$z_fbL,
         z_sbU = sb$z_sbU,
         z_sbL = sb$z_sbL)
```


Plot the results:

```{r fig.width=7,fig.height=3}
plot(TS$frequency/1000, 
     TS$TS, 
     type='l',
     xlab='Frequency (kHz)', 
     ylab=expression(TS~'('~dB~re~ m^-2~')'))
```

We can also run a simulation over multiple parameters, for example frequencies from 120-200 kHz and incident angles from 65-115 degrees:  

```{r}
TS = krm.sim(frequency =seq(120,200.1) * 1000,
         c.w = 1490,
         rho.w = 1030,
         theta=65:115,
         c.fb = 1570,
         c.sb = 345,
         rho.sb = 1.24,
         rho.fb = 1070,
         L=0.21,
         x_fb = fb$x_fb,
         x_sb = sb$x_sb,
         w_fb = fb$w_fb,
         w_sb = sb$w_sb,
         z_fbU = fb$z_fbU,
         z_fbL = fb$z_fbL,
         z_sbU = sb$z_sbU,
         z_sbL = sb$z_sbL)
```


We can for example use ggplot2 to plot a 2D map of the results:

```{r , fig.width=7,fig.height=6}
ggplot2::ggplot(data=TS, ggplot2::aes(x= frequency/1000, y= theta, fill=TS))+
  ggplot2::geom_tile()+
  ggplot2::scale_fill_viridis_c(expression(TS~'('~dB~re~ m^-1~')'))+
  ggplot2::xlab('Frequency (kHz)')+
  ggplot2::ylab(expression(theta~'(°)'))+
  ggplot2::scale_x_continuous(expand=c(0,0))+
  ggplot2::scale_y_continuous(expand=c(0,0))+
  ggplot2::theme_classic()+
  ggplot2::theme(legend.position='top',
        legend.text=element_text(angle=45),
        text=element_text(size=16))
```
